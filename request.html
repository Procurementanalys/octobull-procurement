<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Store Request Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
  }
  
  .animate-slideIn { animation: slideIn 0.5s ease-out; }
  .animate-fadeIn { animation: fadeIn 0.6s ease-out; }
  .animate-pulse-slow { animation: pulse 3s ease-in-out infinite; }
  .icon-float { animation: float 3s ease-in-out infinite; }
  
  /* Octobull Theme */
  .gradient-octobull {
    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 50%, #1E88E5 100%);
  }
  .gradient-octobull-light {
    background: linear-gradient(135deg, #FFF5F0 0%, #E3F2FD 100%);
  }
  .bg-octobull-orange { background: linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%); }
  .bg-octobull-blue { background: linear-gradient(135deg, #1E88E5 0%, #42A5F5 100%); }
  .bg-octobull-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
  .text-octobull-orange { color: #FF6B35; }
  .text-octobull-blue { color: #1E88E5; }
  
  body {
    background: linear-gradient(135deg, #FFF5F0 0%, #E3F2FD 100%);
  }
  
  .card-shadow {
    box-shadow: 0 15px 50px rgba(255, 107, 53, 0.15);
  }
  
  .card-hover:hover {
    transform: translateY(-8px);
    box-shadow: 0 25px 60px rgba(255, 107, 53, 0.25);
    transition: all 0.4s ease;
  }
  
  input:focus, button:focus, select:focus { 
    outline: none; 
  }
  
  input:focus, select:focus {
    border-color: #FF6B35;
    box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
    transform: scale(1.02);
    transition: all 0.3s ease;
  }
  
  .btn-octobull {
    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
    transition: all 0.3s ease;
  }
  .btn-octobull:hover {
    background: linear-gradient(135deg, #F7931E 0%, #FF6B35 100%);
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(255, 107, 53, 0.4);
  }
  
  .btn-green-octobull {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  }
  .btn-green-octobull:hover {
    background: linear-gradient(135deg, #059669 0%, #10b981 100%);
    transform: translateY(-3px);
    box-shadow: 0 15px 35px rgba(16, 185, 129, 0.4);
  }
  
  .badge-pending { 
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); 
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-weight: 700;
    font-size: 0.75rem;
  }
  .badge-approved { 
    background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-weight: 700;
    font-size: 0.75rem;
  }
  .badge-rejected { 
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-weight: 700;
    font-size: 0.75rem;
  }
  
  .table-header {
    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
    color: white;
  }
  
  .table-header-blue {
    background: linear-gradient(135deg, #1E88E5 0%, #42A5F5 100%);
    color: white;
  }
  
  tbody tr:hover {
    background: linear-gradient(90deg, rgba(255, 107, 53, 0.05) 0%, rgba(30, 136, 229, 0.05) 100%);
    transition: all 0.3s ease;
  }
  
  /* Bull Decorations */
  .bull-icon-header {
    animation: float 3s ease-in-out infinite;
  }
  
  /* Decorative Elements */
  .deco-bull {
    position: fixed;
    font-size: 4rem;
    opacity: 0.05;
    pointer-events: none;
    animation: float 5s ease-in-out infinite;
  }
  .deco-bull-1 { top: 10%; left: 5%; animation-delay: 0s; }
  .deco-bull-2 { top: 60%; right: 8%; animation-delay: 2s; }
</style>
</head>
<body class="min-h-screen">

<!-- Decorative Bulls -->
<div class="deco-bull deco-bull-1">üêÇ</div>
<div class="deco-bull deco-bull-2">üìà</div>

<!-- Header -->
<div class="gradient-octobull text-white px-6 py-8 shadow-2xl">
  <div class="max-w-5xl mx-auto flex justify-between items-center">
    <div class="flex items-center gap-4">
      <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur-sm shadow-2xl bull-icon-header">
        <span class="text-4xl">üêÇ</span>
      </div>
      <div>
        <h2 class="text-3xl font-extrabold tracking-tight">Form Request Barang</h2>
        <p class="text-base text-white/90 mt-1 font-medium">
          <i class="fas fa-chart-line mr-2"></i>Octobull Procurement System
        </p>
      </div>
    </div>
    <button onclick="logout()" class="flex items-center gap-3 bg-white/20 hover:bg-white/30 px-6 py-3 rounded-2xl transition-all backdrop-blur-sm shadow-lg hover:scale-105 font-semibold">
      <i class="fas fa-sign-out-alt text-xl"></i>
      <span>Logout</span>
    </button>
  </div>
</div>

<div class="max-w-5xl mx-auto py-10 px-4">
  
  <!-- Form Tambah Item -->
  <div class="bg-white shadow-2xl rounded-3xl p-10 mb-10 card-shadow animate-slideIn card-hover">
    <div class="flex items-center gap-4 mb-8">
      <div class="w-14 h-14 bg-octobull-orange rounded-2xl flex items-center justify-center shadow-xl">
        <i class="fas fa-plus text-white text-2xl"></i>
      </div>
      <h3 class="text-2xl font-extrabold bg-gradient-to-r from-orange-600 to-blue-600 bg-clip-text text-transparent">
        Tambah Item Request
      </h3>
    </div>
    
    <div class="grid grid-cols-5 gap-5 items-end mb-8">
      <div class="col-span-2 relative">
        <label class="block text-sm font-bold text-gray-700 mb-3">
          <i class="fas fa-search text-octobull-orange mr-1"></i> Cari Item
        </label>
        <input type="text" id="itemSearch" placeholder="Ketik untuk mencari..." 
          class="w-full p-4 border-3 border-gray-300 rounded-2xl focus:ring-4 focus:ring-orange-200 transition-all font-medium shadow-lg" 
          oninput="filterItems(this.value)">
        <div id="itemList" class="absolute bg-white border-2 border-gray-300 rounded-2xl shadow-2xl hidden z-10 w-full max-h-48 overflow-auto mt-2"></div>
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-3">
          <i class="fas fa-hashtag text-green-500 mr-1"></i> Qty
        </label>
        <input type="number" id="qty" placeholder="0" 
          class="w-full p-4 border-3 border-gray-300 rounded-2xl focus:ring-4 focus:ring-green-200 transition-all font-semibold shadow-lg">
      </div>
      <div>
        <label class="block text-sm font-bold text-gray-700 mb-3">
          <i class="fas fa-comment text-blue-500 mr-1"></i> Remarks
        </label>
        <input type="text" id="remarks" placeholder="Catatan..." 
          class="w-full p-4 border-3 border-gray-300 rounded-2xl focus:ring-4 focus:ring-blue-200 transition-all font-medium shadow-lg">
      </div>
      <button onclick="addItem()" 
        class="btn-octobull text-white rounded-2xl py-4 px-6 font-bold transition-all flex items-center justify-center gap-2 shadow-2xl text-base">
        <i class="fas fa-plus-circle text-xl"></i>
        <span>Tambah</span>
      </button>
    </div>

    <div class="overflow-x-auto rounded-2xl border-3 border-gray-200 shadow-xl">
      <table id="requestTable" class="w-full">
        <thead class="table-header">
          <tr>
            <th class="px-5 py-4 text-left font-bold border-r border-white/20">
              <i class="fas fa-box mr-2"></i>Item
            </th>
            <th class="px-5 py-4 text-left font-bold border-r border-white/20">
              <i class="fas fa-sort-numeric-up mr-2"></i>Qty
            </th>
            <th class="px-5 py-4 text-left font-bold border-r border-white/20">
              <i class="fas fa-comment-dots mr-2"></i>Remarks
            </th>
            <th class="px-5 py-4 text-center font-bold">
              <i class="fas fa-cog mr-2"></i>Aksi
            </th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <button onclick="submitRequest()" 
      class="mt-8 w-full btn-green-octobull text-white py-5 rounded-2xl hover:shadow-2xl transition-all font-extrabold text-xl flex items-center justify-center gap-4 shadow-xl">
      <i class="fas fa-paper-plane text-2xl"></i>
      <span>Submit Request</span>
    </button>
    <p id="msg" class="text-center text-base mt-5 font-bold"></p>
  </div>

  <!-- Ticket List -->
  <div class="bg-white shadow-2xl rounded-3xl p-10 card-shadow animate-fadeIn card-hover">
    <div class="flex items-center gap-4 mb-8">
      <div class="w-14 h-14 bg-octobull-blue rounded-2xl flex items-center justify-center shadow-xl animate-pulse-slow">
        <i class="fas fa-ticket-alt text-white text-2xl"></i>
      </div>
      <h3 class="text-2xl font-extrabold bg-gradient-to-r from-blue-600 to-orange-600 bg-clip-text text-transparent">
        Daftar Ticket Saya
      </h3>
    </div>
    <ul id="ticketList" class="space-y-4"></ul>
    <div id="ticketDetail" class="mt-8"></div>
  </div>
</div>

<script>
const BASE_URL = 'https://script.google.com/macros/s/AKfycbyEIxM30bhdFSv62EwNJ3yO6V5I-b_g3ZhXWzVea6rbZj7j1Nq_-ljdIPG5yk5skVtJjw/exec';
const store_code = localStorage.getItem("store_code");
if(!store_code) window.location.href="login.html";

let items=[], selectedItems=[];

async function loadItems(){ const res=await fetch(`${BASE_URL}?action=getItems`); items=await res.json(); }
function filterItems(value){
  const list=document.getElementById("itemList");
  list.innerHTML="";
  if(!value) return list.classList.add("hidden");
  const filtered=items.filter(it=>it.item_name.toLowerCase().includes(value.toLowerCase()));
  filtered.slice(0,5).forEach(it=>{
    const div=document.createElement("div");
    div.innerHTML=`<i class="fas fa-cube text-orange-500 mr-2"></i><span class="font-medium">${it.item_id} - ${it.item_name}</span>`;
    div.className="p-4 hover:bg-orange-50 cursor-pointer transition-colors border-b last:border-b-0 font-medium";
    div.onclick=()=>selectItem(it);
    list.appendChild(div);
  });
  list.classList.remove("hidden");
}
function selectItem(it){
  document.getElementById("itemSearch").value=it.item_name;
  document.getElementById("itemSearch").dataset.itemId=it.item_id;
  document.getElementById("itemList").classList.add("hidden");
}
function addItem(){
  const item_name=document.getElementById("itemSearch").value;
  const item_id=document.getElementById("itemSearch").dataset.itemId;
  const qty=document.getElementById("qty").value;
  const remarks=document.getElementById("remarks").value;
  if(!item_id||!qty)return alert("Pilih item dan isi qty!");
  selectedItems.push({item_id,item_name,qty,remarks});
  renderTable();
  document.getElementById("itemSearch").value="";
  document.getElementById("qty").value="";
  document.getElementById("remarks").value="";
}
function renderTable(){
  const tbody=document.querySelector("#requestTable tbody");
  tbody.innerHTML="";
  selectedItems.forEach((it,idx)=>{
    tbody.innerHTML+=`<tr class="border-b hover:bg-gray-50 transition-colors">
      <td class="px-5 py-4 font-semibold text-gray-800">${it.item_name}</td>
      <td class="px-5 py-4 font-bold text-green-600 text-lg">${it.qty}</td>
      <td class="px-5 py-4 text-gray-600">${it.remarks}</td>
      <td class="px-5 py-4 text-center">
        <button onclick="removeItem(${idx})" class="text-red-600 hover:text-red-800 hover:bg-red-50 px-4 py-2 rounded-xl transition-all font-semibold shadow-md hover:shadow-lg">
          <i class="fas fa-trash-alt mr-2"></i>Hapus
        </button>
      </td>
    </tr>`;
  });
}
function removeItem(i){selectedItems.splice(i,1);renderTable();}
async function submitRequest(){
  if(selectedItems.length===0)return alert("Tambahkan minimal satu item!");
  const msg=document.getElementById("msg");
  msg.innerText="Mengirim...";
  const res=await fetch(`${BASE_URL}?action=submitRequest&store_code=${store_code}&items=${encodeURIComponent(JSON.stringify(selectedItems))}`);
  const data=await res.json();
  if(data.success){msg.innerText=`‚úÖ Berhasil dikirim! Ticket ID: ${data.ticket_id}`;msg.className="text-center text-base mt-5 font-bold text-green-600";selectedItems=[];renderTable();loadTickets();}
  else{msg.innerText="‚ùå Gagal submit request.";msg.className="text-center text-base mt-5 font-bold text-red-600";}
}
async function loadTickets(){
  const res=await fetch(`${BASE_URL}?action=getRequests&store_code=${store_code}`);
  const data=await res.json();
  const ticketList=document.getElementById("ticketList");
  ticketList.innerHTML="";
  const uniqueTickets=[...new Set(data.map(r=>r.ticket_id))];
  uniqueTickets.forEach(t=>{
    const ticketData=data.filter(r=>r.ticket_id===t);
    const status=ticketData[0].status||"Pending";
    const div=document.createElement("div");
    div.className="p-6 bg-gradient-to-r from-orange-50 to-blue-50 border-3 border-gray-200 rounded-2xl hover:border-orange-400 hover:shadow-2xl cursor-pointer transition-all";
    div.innerHTML=`<div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <i class="fas fa-ticket-alt text-orange-500 text-2xl"></i>
          <span class="font-extrabold text-gray-800 text-lg">Ticket #${t}</span>
        </div>
        <span class="badge-${status.toLowerCase()}">${status}</span>
      </div>`;
    div.onclick=()=>showTicketDetail(t,ticketData);
    ticketList.appendChild(div);
  });
}
function showTicketDetail(id,items){
  let html=`<div class='p-8 bg-gradient-to-br from-orange-50 via-amber-50 to-blue-50 border-3 border-orange-300 rounded-3xl shadow-2xl'>
    <h4 class='font-extrabold mb-6 text-2xl text-gray-800 flex items-center gap-3'>
      <i class="fas fa-clipboard-list text-orange-600 text-2xl"></i>
      <span>Detail Ticket #${id}</span>
    </h4>
    <div class="overflow-x-auto rounded-2xl shadow-xl">
      <table class='w-full border-2 border-gray-200 rounded-2xl overflow-hidden'>
        <thead class="table-header-blue">
          <tr>
            <th class="px-5 py-4 text-left font-bold border-r border-white/20">Item</th>
            <th class="px-5 py-4 text-left font-bold border-r border-white/20">Qty</th>
            <th class="px-5 py-4 text-left font-bold border-r border-white/20">Remarks</th>
            <th class="px-5 py-4 text-left font-bold border-r border-white/20">Status</th>
            <th class="px-5 py-4 text-left font-bold">Feedback</th>
          </tr>
        </thead>
        <tbody class="bg-white">
          ${items.map(r=>`<tr class='border-t-2 hover:bg-blue-50 transition-colors'>
            <td class="px-5 py-4 font-semibold text-gray-800">${r.item_name}</td>
            <td class="px-5 py-4 font-bold text-green-600 text-lg">${r.qty}</td>
            <td class="px-5 py-4 text-gray-600">${r.remarks}</td>
            <td class="px-5 py-4"><span class="badge-${r.status.toLowerCase()}">${r.status}</span></td>
            <td class="px-5 py-4 text-gray-700 font-medium">${r.feedback || '-'}</td>
          </tr>`).join("")}
        </tbody>
      </table>
    </div>
  </div>`;
  document.getElementById("ticketDetail").innerHTML=html;
}
function logout(){localStorage.clear();window.location.href="login.html";}
loadItems(); loadTickets();
</script>
</body>
</html>
