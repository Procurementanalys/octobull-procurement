<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Store Request Form</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .animate-slideIn { animation: slideIn 0.5s ease-out; }
  .animate-fadeIn { animation: fadeIn 0.6s ease-out; }
  .gradient-header {
    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 50%, #1E3A8A 100%);
  }
  .card-shadow {
    box-shadow: 0 10px 40px rgba(255, 107, 53, 0.15);
  }
  .card-hover:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 50px rgba(255, 107, 53, 0.25);
    transition: all 0.3s ease;
  }
  input:focus, button:focus {
    outline: none;
  }
  .btn-primary {
    background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, #F7931E 0%, #FF6B35 100%);
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(247, 147, 30, 0.4);
  }
  .badge-pending { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
  .badge-approved { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
  .badge-rejected { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
  .table-header {
    background: linear-gradient(135deg, #FFF5F0 0%, #FFE8DD 100%);
  }
  body {
    background: linear-gradient(135deg, #FFF8F3 0%, #FFE8DD 50%, #E3F2FD 100%);
  }
</style>
</head>
<body class="min-h-screen">

<!-- Header -->
<div class="gradient-header text-white px-6 py-6 shadow-xl">
  <div class="max-w-4xl mx-auto flex justify-between items-center">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
        <i class="fas fa-box-open text-2xl"></i>
      </div>
      <div>
        <h2 class="text-2xl font-bold">Form Request Barang</h2>
        <p class="text-sm text-white/80">Procurement System</p>
      </div>
    </div>
    <button onclick="logout()" class="flex items-center gap-2 bg-white/20 hover:bg-white/30 px-4 py-2 rounded-xl transition-all backdrop-blur-sm">
      <i class="fas fa-sign-out-alt"></i>
      <span class="font-medium">Logout</span>
    </button>
  </div>
</div>

<div class="max-w-4xl mx-auto py-8 px-4">
  
  <!-- Form Tambah Item -->
  <div class="bg-white shadow-xl rounded-2xl p-8 mb-8 card-shadow animate-slideIn card-hover">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-yellow-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-plus text-white"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-800">Tambah Item Request</h3>
    </div>
    
    <div class="grid grid-cols-5 gap-4 items-end mb-6">
      <!-- Search Item -->
      <div class="col-span-2 relative">
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-search text-orange-500"></i> Cari Item
        </label>
        <input type="text" id="itemSearch" placeholder="Ketik untuk mencari..." 
          class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-orange-200 focus:border-orange-400 transition-all" 
          oninput="filterItems(this.value)">
        <div id="itemList" class="absolute bg-white border-2 border-gray-200 rounded-xl shadow-xl hidden z-10 w-full max-h-40 overflow-auto mt-1"></div>
      </div>
      
      <!-- Quantity -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-hashtag text-green-500"></i> Qty
        </label>
        <input type="number" id="qty" placeholder="0" 
          class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-green-200 focus:border-green-400 transition-all">
      </div>
      
      <!-- Remarks -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-comment text-yellow-500"></i> Remarks
        </label>
        <input type="text" id="remarks" placeholder="Catatan..." 
          class="w-full p-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-yellow-200 focus:border-yellow-400 transition-all">
      </div>
      
      <!-- Add Button -->
      <button onclick="addItem()" 
        class="btn-primary text-white rounded-xl py-3 px-6 font-semibold transition-all flex items-center justify-center gap-2 shadow-lg">
        <i class="fas fa-plus-circle"></i>
        <span>Tambah</span>
      </button>
    </div>

    <!-- Request Table -->
    <div class="overflow-x-auto rounded-xl border-2 border-orange-100">
      <table id="requestTable" class="w-full">
        <thead class="table-header">
          <tr>
            <th class="px-4 py-3 text-left font-semibold text-gray-700">
              <i class="fas fa-box mr-2 text-orange-500"></i>Item
            </th>
            <th class="px-4 py-3 text-left font-semibold text-gray-700">
              <i class="fas fa-sort-numeric-up mr-2 text-green-500"></i>Qty
            </th>
            <th class="px-4 py-3 text-left font-semibold text-gray-700">
              <i class="fas fa-comment-dots mr-2 text-yellow-500"></i>Remarks
            </th>
            <th class="px-4 py-3 text-center font-semibold text-gray-700">
              <i class="fas fa-cog mr-2 text-red-500"></i>Aksi
            </th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Submit Button -->
    <button onclick="submitRequest()" 
      class="mt-6 w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl hover:shadow-2xl transition-all font-bold text-lg flex items-center justify-center gap-3">
      <i class="fas fa-paper-plane"></i>
      <span>Submit Request</span>
    </button>
    <p id="msg" class="text-center text-sm mt-4 font-semibold"></p>
  </div>

  <!-- Ticket List -->
  <div class="bg-white shadow-xl rounded-2xl p-8 card-shadow animate-fadeIn card-hover">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-pink-600 rounded-xl flex items-center justify-center">
        <i class="fas fa-ticket-alt text-white"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-800">Daftar Ticket Saya</h3>
    </div>
    <ul id="ticketList" class="space-y-3"></ul>
    <div id="ticketDetail" class="mt-6"></div>
  </div>
</div>

<script>
const BASE_URL = 'https://script.google.com/macros/s/AKfycbzkbIrP2o6-LR2aq2E44dHMmzpdct3Hx_tg6AinU_93o3IYjbtcmtE63Zvh-IbDYQP7Yw/exec';
const store_code = localStorage.getItem("store_code");
if(!store_code) window.location.href="login.html";

let items=[], selectedItems=[];

// Load item master
async function loadItems(){
  const res = await fetch(`${BASE_URL}?action=getItems`);
  items = await res.json();
}

// Filter item search
function filterItems(value){
  const list = document.getElementById("itemList");
  list.innerHTML="";
  if(!value) return list.classList.add("hidden");
  const filtered = items.filter(it=>it.item_name.toLowerCase().includes(value.toLowerCase()));
  filtered.slice(0,5).forEach(it=>{
    const div = document.createElement("div");
    div.innerHTML=`<i class="fas fa-cube text-orange-400 mr-2"></i>${it.item_id} - ${it.item_name}`;
    div.className="p-3 hover:bg-orange-50 cursor-pointer transition-colors border-b last:border-b-0";
    div.onclick=()=>selectItem(it);
    list.appendChild(div);
  });
  list.classList.remove("hidden");
}

function selectItem(it){
  document.getElementById("itemSearch").value=it.item_name;
  document.getElementById("itemSearch").dataset.itemId=it.item_id;
  document.getElementById("itemList").classList.add("hidden");
}

// Add item ke list
function addItem(){
  const item_name=document.getElementById("itemSearch").value;
  const item_id=document.getElementById("itemSearch").dataset.itemId;
  const qty=document.getElementById("qty").value;
  const remarks=document.getElementById("remarks").value;
  if(!item_id || !qty) return alert("Pilih item dan isi qty!");
  selectedItems.push({item_id,item_name,qty,remarks});
  renderTable();
  document.getElementById("itemSearch").value="";
  document.getElementById("qty").value="";
  document.getElementById("remarks").value="";
}

// Render tabel
function renderTable(){
  const tbody=document.querySelector("#requestTable tbody");
  tbody.innerHTML="";
  selectedItems.forEach((it,idx)=>{
    tbody.innerHTML+=`<tr class="border-b hover:bg-orange-50 transition-colors">
      <td class="px-4 py-3">${it.item_name}</td>
      <td class="px-4 py-3 font-semibold text-green-600">${it.qty}</td>
      <td class="px-4 py-3 text-gray-600">${it.remarks}</td>
      <td class="px-4 py-3 text-center">
        <button onclick="removeItem(${idx})" class="text-red-500 hover:text-red-700 hover:bg-red-50 px-3 py-1 rounded-lg transition-all">
          <i class="fas fa-trash-alt mr-1"></i>Hapus
        </button>
      </td>
    </tr>`;
  });
}

// Hapus item
function removeItem(i){selectedItems.splice(i,1);renderTable();}

// Submit request
async function submitRequest(){
  if(selectedItems.length===0) return alert("Tambahkan minimal satu item!");
  const msg=document.getElementById("msg");
  msg.innerText="Mengirim...";
  const res=await fetch(`${BASE_URL}?action=submitRequest&store_code=${store_code}&items=${encodeURIComponent(JSON.stringify(selectedItems))}`);
  const data=await res.json();
  if(data.success){
    msg.innerText=`Berhasil dikirim! Ticket ID: ${data.ticket_id}`;
    msg.className="text-center text-sm mt-4 font-semibold text-green-600";
    selectedItems=[];
    renderTable();
    loadTickets();
  }else{
    msg.innerText="Gagal submit request.";
    msg.className="text-center text-sm mt-4 font-semibold text-red-600";
  }
}

// Load ticket list user
async function loadTickets(){
  const res=await fetch(`${BASE_URL}?action=getRequests&store_code=${store_code}`);
  const data=await res.json();
  const ticketList=document.getElementById("ticketList");
  ticketList.innerHTML="";
  const uniqueTickets=[...new Set(data.map(r=>r.ticket_id))];
  uniqueTickets.forEach(t=>{
    const ticketData = data.filter(r=>r.ticket_id===t);
    const status = ticketData[0].status || "Pending";
    const div=document.createElement("div");
    div.className="p-4 bg-gradient-to-r from-orange-50 to-white border-2 border-orange-200 rounded-xl hover:border-orange-400 hover:shadow-lg cursor-pointer transition-all";
    div.innerHTML=`
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="fas fa-ticket-alt text-orange-500 text-xl"></i>
          <span class="font-semibold text-gray-800">Ticket #${t}</span>
        </div>
        <span class="px-3 py-1 rounded-full text-xs font-bold text-white ${
          status==='Approved'?'badge-approved':status==='Rejected'?'badge-rejected':'badge-pending'
        }">${status}</span>
      </div>
    `;
    div.onclick=()=>showTicketDetail(t,ticketData);
    ticketList.appendChild(div);
  });
}

// Show detail ticket
function showTicketDetail(id,items){
  let html=`<div class='p-6 bg-gradient-to-br from-orange-50 to-yellow-50 border-2 border-orange-200 rounded-xl shadow-lg'>
    <h4 class='font-bold mb-4 text-lg text-gray-800 flex items-center gap-2'>
      <i class="fas fa-clipboard-list text-orange-600"></i>
      Detail Ticket #${id}
    </h4>
    <div class="overflow-x-auto">
      <table class='w-full text-sm border-2 border-gray-200 rounded-lg overflow-hidden'>
        <thead class="table-header">
          <tr>
            <th class="px-3 py-2 text-left font-semibold">Item</th>
            <th class="px-3 py-2 text-left font-semibold">Qty</th>
            <th class="px-3 py-2 text-left font-semibold">Remarks</th>
            <th class="px-3 py-2 text-left font-semibold">Status</th>
          </tr>
        </thead>
        <tbody>
          ${items.map(r=>`<tr class='border-t hover:bg-white/50'>
            <td class="px-3 py-2">${r.item_name}</td>
            <td class="px-3 py-2 font-semibold text-green-600">${r.qty}</td>
            <td class="px-3 py-2 text-gray-600">${r.remarks}</td>
            <td class="px-3 py-2">
              <span class="px-2 py-1 rounded-full text-xs font-bold text-white ${
                r.status==='Approved'?'badge-approved':r.status==='Rejected'?'badge-rejected':'badge-pending'
              }">${r.status}</span>
            </td>
          </tr>`).join("")}
        </tbody>
      </table>
    </div>
  </div>`;
  document.getElementById("ticketDetail").innerHTML=html;
}

// Logout
function logout(){localStorage.clear();window.location.href="login.html";}

loadItems(); loadTickets();
</script>
</body>
</html>